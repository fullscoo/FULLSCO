import express, { type Express, type Request, type Response, NextFunction } from "express";
import { createServer, type Server } from "http";
import { storage } from "./storage-fixed";
import { 
  insertUserSchema, 
  insertScholarshipSchema,
  insertPostSchema,
  insertCategorySchema,
  insertLevelSchema,
  insertCountrySchema,
  insertTagSchema,
  insertSuccessStorySchema,
  insertSubscriberSchema,
  insertSeoSettingsSchema,
  insertSiteSettingsSchema,
  insertPageSchema,
  insertMenuSchema,
  insertMenuItemSchema,
  insertMediaFileSchema,
  insertStatisticSchema,
  insertPartnerSchema,
  User,
  menuLocationEnum
} from "@shared/schema";
import session from "express-session";
import passport from "passport";
import { Strategy as LocalStrategy } from "passport-local";
import MemoryStore from "memorystore";
import multer from "multer";
import path from "path";
import fs from "fs";
import sizeOf from "image-size";

/**
 * ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
 * Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© ØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
 */
export async function registerRoutes(app: Express): Promise<Server> {
  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
  const migratedModules = [
    'auth',           // Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    'users',          // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    'site-settings',  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
    'statistics',     // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    'partners',       // Ø§Ù„Ø´Ø±ÙƒØ§Ø¡
    'scholarships',   // Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
    'posts',          // Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
    'success-stories' // Ù‚ØµØµ Ø§Ù„Ù†Ø¬Ø§Ø­
  ];

  console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª...');
  
  try {
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const routesModule = await import('./routes/index');
    if (typeof routesModule.registerApiRoutes === 'function') {
      console.log('âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯');
      routesModule.registerApiRoutes(app, '/api');
      console.log(`ğŸ“‹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„Ø©: ${migratedModules.join(', ')}`);
    }
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', error);
  }
  
  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¨Ø¹Ø¯
  console.log('âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©');
  registerLegacyRoutes(app, migratedModules);
  
  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø®Ø§Ø¯Ù… HTTP
  const httpServer = createServer(app);
  return httpServer;
}

/**
 * ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
 * @param app ØªØ·Ø¨ÙŠÙ‚ Express
 * @param migratedModules Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
 */
export function registerLegacyRoutes(app: Express, migratedModules: string[] = []): void {
  // Set up uploads directory
  const uploadsDir = path.join(process.cwd(), 'uploads');
  if (!fs.existsSync(uploadsDir)) {
    fs.mkdirSync(uploadsDir, { recursive: true });
  }
  
  // Serve static files from uploads directory
  app.use('/uploads', express.static(uploadsDir));

  // Set up multer for file uploads
  const multerStorage = multer.diskStorage({
    destination: function (req, file, cb) {
      cb(null, uploadsDir);
    },
    filename: function (req, file, cb) {
      const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
      const ext = path.extname(file.originalname);
      cb(null, uniqueSuffix + ext);
    }
  });
  
  const upload = multer({ 
    storage: multerStorage,
    limits: { fileSize: 5 * 1024 * 1024 }, // 5MB limit
    fileFilter: function (req, file, cb) {
      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©
      if (file.mimetype.startsWith('image/')) {
        cb(null, true);
      } else {
        cb(new Error('Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ù„ÙŠØ³ ØµÙˆØ±Ø©!') as any, false);
      }
    }
  });

  // Set up authentication
  const MemorySessionStore = MemoryStore(session);
  
  app.use(
    session({
      secret: process.env.SESSION_SECRET || "fullsco-secret-key",
      resave: false,
      saveUninitialized: false,
      cookie: { secure: false, maxAge: 24 * 60 * 60 * 1000 }, // 24 hours
      store: new MemorySessionStore({
        checkPeriod: 86400000, // prune expired entries every 24h
      }),
    })
  );
  
  app.use(passport.initialize());
  app.use(passport.session());

  // Configure passport local strategy
  passport.use(
    new LocalStrategy(async (username, password, done) => {
      try {
        const user = await storage.getUserByUsername(username);
        if (!user) {
          return done(null, false, { message: "Incorrect username" });
        }
        
        if (user.password !== password) {
          return done(null, false, { message: "Incorrect password" });
        }
        
        return done(null, user);
      } catch (err) {
        return done(err);
      }
    })
  );

  passport.serializeUser((user: any, done) => {
    done(null, user.id);
  });

  passport.deserializeUser(async (id: number, done) => {
    try {
      const user = await storage.getUser(id);
      done(null, user);
    } catch (err) {
      done(err);
    }
  });

  // Auth middleware
  const isAuthenticated = (req: Request, res: Response, next: Function) => {
    if (req.isAuthenticated()) {
      return next();
    }
    res.status(401).json({ message: "Unauthorized" });
  };

  const isAdmin = (req: Request, res: Response, next: Function) => {
    if (req.isAuthenticated() && req.user && (req.user as any).role === "admin") {
      return next();
    }
    res.status(403).json({ message: "Forbidden: Admin access required" });
  };

  // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø§Ø±Ø§Øª API Ø§Ø³ØªÙ†Ø§Ø¯Ù‹Ø§ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¨Ø¹Ø¯
  
  // === ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth) ===
  if (!migratedModules.includes('auth')) {
    console.log('âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (auth)');
    // Authentication routes
    app.post("/api/auth/login", (req, res, next) => {
      passport.authenticate("local", (err: any, user: any, info: any) => {
        if (err) {
          return next(err);
        }
        if (!user) {
          return res.status(401).json({ message: info.message });
        }
        req.login(user, (err) => {
          if (err) {
            return next(err);
          }
          
          // Remove password from response
          const userResponse = { ...user };
          delete userResponse.password;
          
          return res.json(userResponse);
        });
      })(req, res, next);
    });

    app.post("/api/auth/logout", (req, res) => {
      req.logout((err) => {
        if (err) {
          return res.status(500).json({ message: "Error logging out" });
        }
        res.json({ message: "Logged out successfully" });
      });
    });

    app.get("/api/auth/me", (req, res) => {
      if (!req.isAuthenticated()) {
        return res.status(401).json({ message: "Not authenticated" });
      }
      
      // Remove password from response
      const userResponse = { ...req.user as any };
      delete userResponse.password;
      
      res.json(userResponse);
    });
  }

  // === ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Users) ===
  if (!migratedModules.includes('users')) {
    console.log('âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (users)');
    // User routes
    app.post("/api/users", isAdmin, async (req, res) => {
      try {
        const data = insertUserSchema.parse(req.body);
        const user = await storage.createUser(data);
        res.status(201).json(user);
      } catch (error) {
        res.status(400).json({ message: (error as Error).message });
      }
    });

    app.get("/api/users", isAdmin, async (req, res) => {
      const users = await storage.listUsers();
      // Remove passwords from response
      const safeUsers = users.map(user => {
        const { password, ...userWithoutPassword } = user;
        return userWithoutPassword;
      });
      res.json(safeUsers);
    });
  }

  // Category routes
  app.post("/api/categories", isAdmin, async (req, res) => {
    try {
      const data = insertCategorySchema.parse(req.body);
      const category = await storage.createCategory(data);
      res.status(201).json(category);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/categories", async (req, res) => {
    const categories = await storage.listCategories();
    res.json(categories);
  });

  app.get("/api/categories/:id", async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid category ID" });
    }
    const category = await storage.getCategory(id);
    if (!category) {
      return res.status(404).json({ message: "Category not found" });
    }
    res.json(category);
  });

  app.put("/api/categories/:id", isAdmin, async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid category ID" });
    }
    try {
      const data = insertCategorySchema.partial().parse(req.body);
      const category = await storage.updateCategory(id, data);
      if (!category) {
        return res.status(404).json({ message: "Category not found" });
      }
      res.json(category);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.delete("/api/categories/:id", isAdmin, async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid category ID" });
    }
    const success = await storage.deleteCategory(id);
    if (!success) {
      return res.status(404).json({ message: "Category not found" });
    }
    res.json({ message: "Category deleted successfully" });
  });

  // Level routes
  app.post("/api/levels", isAdmin, async (req, res) => {
    try {
      const data = insertLevelSchema.parse(req.body);
      const level = await storage.createLevel(data);
      res.status(201).json(level);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/levels", async (req, res) => {
    const levels = await storage.listLevels();
    res.json(levels);
  });

  // Country routes
  app.post("/api/countries", isAdmin, async (req, res) => {
    try {
      const data = insertCountrySchema.parse(req.body);
      const country = await storage.createCountry(data);
      res.status(201).json(country);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/countries", async (req, res) => {
    const countries = await storage.listCountries();
    res.json(countries);
  });

  // === ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© (Scholarships) ===
  if (!migratedModules.includes('scholarships')) {
    console.log('âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (scholarships)');
    // Scholarship routes
    app.post("/api/scholarships", isAdmin, async (req, res) => {
      try {
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const processedBody = {
          ...req.body,
          startDate: req.body.startDate ? new Date(req.body.startDate) : null,
          endDate: req.body.endDate ? new Date(req.body.endDate) : null
        };
        
        const data = insertScholarshipSchema.parse(processedBody);
        const scholarship = await storage.createScholarship(data);
        res.status(201).json(scholarship);
      } catch (error) {
        console.error("Error creating scholarship:", error);
        res.status(400).json({ message: (error as Error).message });
      }
    });

    app.get("/api/scholarships", async (req, res) => {
      const { featured, country, level, category } = req.query;
      const filters: any = {};
      
      if (featured !== undefined) {
        filters.isFeatured = featured === "true";
      }
      
      if (country) {
        const countryId = parseInt(country as string);
        if (!isNaN(countryId)) {
          filters.countryId = countryId;
        }
      }
      
      if (level) {
        const levelId = parseInt(level as string);
        if (!isNaN(levelId)) {
          filters.levelId = levelId;
        }
      }
      
      if (category) {
        const categoryId = parseInt(category as string);
        if (!isNaN(categoryId)) {
          filters.categoryId = categoryId;
        }
      }
      
      const scholarships = await storage.listScholarships(Object.keys(filters).length > 0 ? filters : undefined);
      res.json(scholarships);
    });

    // Ù…Ø³Ø§Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ù…Ù…ÙŠØ²Ø©
    app.get("/api/scholarships/featured", async (req, res) => {
      try {
        const scholarships = await storage.listScholarships({ isFeatured: true });
        res.json(scholarships);
      } catch (error) {
        console.error("Error fetching featured scholarships:", error);
        res.status(500).json({ message: "Failed to fetch featured scholarships", error: (error as Error).message });
      }
    });

    // Ù…Ø³Ø§Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø­Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù€ slug
    app.get("/api/scholarships/slug/:slug", async (req, res) => {
      try {
        const slug = req.params.slug;
        const scholarship = await storage.getScholarshipBySlug(slug);
        if (!scholarship) {
          return res.status(404).json({ message: "Scholarship not found" });
        }
        res.json(scholarship);
      } catch (error) {
        console.error("Error fetching scholarship by slug:", error);
        res.status(500).json({ message: "Failed to fetch scholarship", error: (error as Error).message });
      }
    });
    
    // Ù…Ø³Ø§Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø­Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø¹Ø±Ù (ID)
    // Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø«Ù„ /featured Ùˆ /slug
    app.get("/api/scholarships/:id", async (req, res) => {
      try {
        const id = parseInt(req.params.id);
        if (isNaN(id)) {
          return res.status(400).json({ message: "Invalid scholarship ID" });
        }
        console.log(`Fetching scholarship with ID: ${id}`);
        const scholarship = await storage.getScholarship(id);
        if (!scholarship) {
          return res.status(404).json({ message: "Scholarship not found" });
        }
        res.json(scholarship);
      } catch (error) {
        console.error(`Error fetching scholarship with ID ${req.params.id}:`, error);
        res.status(500).json({ message: "Failed to fetch scholarship", error: (error as Error).message });
      }
    });

    // ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ÙƒÙ„ Ù…Ù† PUT Ùˆ PATCH Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
    app.put("/api/scholarships/:id", isAdmin, handleUpdateScholarship);
    app.patch("/api/scholarships/:id", isAdmin, handleUpdateScholarship);
    
    // Ù…ÙØ¹Ø§Ù„Ø¬ Ù…Ø´ØªØ±Ùƒ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
    async function handleUpdateScholarship(req: Request, res: Response) {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid scholarship ID" });
      }
      try {
        console.log("Scholarship update request body:", JSON.stringify(req.body, null, 2));
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const processedBody = {
          ...req.body,
          startDate: req.body.startDate ? new Date(req.body.startDate) : null,
          endDate: req.body.endDate ? new Date(req.body.endDate) : null
        };
        
        const data = insertScholarshipSchema.partial().parse(processedBody);
        console.log("Parsed scholarship data:", JSON.stringify(data, null, 2));
        
        const scholarship = await storage.updateScholarship(id, data);
        if (!scholarship) {
          return res.status(404).json({ message: "Scholarship not found" });
        }
        res.json(scholarship);
      } catch (error) {
        console.error("Error updating scholarship:", error);
        res.status(400).json({ message: (error as Error).message });
      }
    }

    app.delete("/api/scholarships/:id", isAdmin, async (req, res) => {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid scholarship ID" });
      }
      const success = await storage.deleteScholarship(id);
      if (!success) {
        return res.status(404).json({ message: "Scholarship not found" });
      }
      res.json({ message: "Scholarship deleted successfully" });
    });
  }

  // === ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª (Posts) ===
  if (!migratedModules.includes('posts')) {
    console.log('âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (posts)');
    // Post (article) routes
    app.post("/api/posts", isAdmin, async (req, res) => {
    try {
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
      const { tags, ...postData } = req.body;
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø§Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const data = insertPostSchema.parse(postData);
      const post = await storage.createPost(data);
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§Ù„ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
      if (tags && Array.isArray(tags) && tags.length > 0) {
        console.log(`Ø¥Ø¶Ø§ÙØ© ${tags.length} ØªØµÙ†ÙŠÙ Ù„Ù„Ù…Ù‚Ø§Ù„ ${post.id}`);
        
        for (const tagId of tags) {
          try {
            await storage.addTagToPost(post.id, parseInt(tagId));
          } catch (tagError) {
            console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ ${tagId} Ù„Ù„Ù…Ù‚Ø§Ù„ ${post.id}:`, tagError);
          }
        }
      }
      
      // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù‚Ø§Ù„ Ø§Ù„Ù…Ù†Ø´Ø£ Ù…Ø¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
      const postWithTags = await storage.getPost(post.id);
      const postTags = await storage.getPostTags(post.id);
      
      res.status(201).json({ ...postWithTags, tags: postTags });
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø§Ù„:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/posts", async (req, res) => {
    const { featured, author } = req.query;
    const filters: any = {};
    
    if (featured !== undefined) {
      filters.isFeatured = featured === "true";
    }
    
    if (author) {
      const authorId = parseInt(author as string);
      if (!isNaN(authorId)) {
        filters.authorId = authorId;
      }
    }
    
    const posts = await storage.listPosts(Object.keys(filters).length > 0 ? filters : undefined);
    res.json(posts);
  });

  app.get("/api/posts/featured", async (req, res) => {
    try {
      const posts = await storage.listPosts({ isFeatured: true });
      res.json(posts);
    } catch (error) {
      console.error("Error fetching featured posts:", error);
      res.status(500).json({ message: "Failed to fetch featured posts", error: (error as Error).message });
    }
  });

  app.get("/api/posts/slug/:slug", async (req, res) => {
    try {
      const slug = req.params.slug;
      const post = await storage.getPostBySlug(slug);
      if (!post) {
        return res.status(404).json({ message: "Post not found" });
      }
      
      // Increment view count
      await storage.incrementPostViews(post.id);
      
      // Get updated post with incremented view count
      const updatedPost = await storage.getPost(post.id);
      res.json(updatedPost);
    } catch (error) {
      console.error("Error fetching post by slug:", error);
      res.status(500).json({ message: "Failed to fetch post", error: (error as Error).message });
    }
  });
  
  app.get("/api/posts/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid post ID" });
      }
      console.log(`Fetching post with ID: ${id}`);
      const post = await storage.getPost(id);
      if (!post) {
        return res.status(404).json({ message: "Post not found" });
      }
      
      // Increment view count
      await storage.incrementPostViews(id);
      
      // Get updated post with incremented view count
      const updatedPost = await storage.getPost(id);
      res.json(updatedPost);
    } catch (error) {
      console.error(`Error fetching post with ID ${req.params.id}:`, error);
      res.status(500).json({ message: "Failed to fetch post", error: (error as Error).message });
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… PUT
  app.put("/api/posts/:id", isAdmin, async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid post ID" });
    }
    try {
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
      const { tags, ...postData } = req.body;
      
      const data = insertPostSchema.partial().parse(postData);
      console.log("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… PUT:", id, data);
      
      const post = await storage.updatePost(id, data);
      if (!post) {
        return res.status(404).json({ message: "Post not found" });
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§
      if (tags !== undefined) {
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const currentTags = await storage.getPostTags(id);
        for (const tag of currentTags) {
          await storage.removeTagFromPost(id, tag.id);
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if (Array.isArray(tags) && tags.length > 0) {
          for (const tagId of tags) {
            try {
              await storage.addTagToPost(id, parseInt(tagId));
            } catch (tagError) {
              console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ ${tagId} Ù„Ù„Ù…Ù‚Ø§Ù„ ${id}:`, tagError);
            }
          }
        }
      }
      
      // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù‚Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø« Ù…Ø¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
      const updatedPost = await storage.getPost(id);
      const postTags = await storage.getPostTags(id);
      
      res.json({ ...updatedPost, tags: postTags });
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ù„:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… PATCH (Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©)
  app.patch("/api/posts/:id", isAdmin, async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid post ID" });
    }
    try {
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
      const { tags, ...postData } = req.body;
      
      const data = insertPostSchema.partial().parse(postData);
      console.log("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… PATCH:", id, data);
      console.log("Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„:", data.content);
      
      const post = await storage.updatePost(id, data);
      if (!post) {
        return res.status(404).json({ message: "Post not found" });
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§
      if (tags !== undefined) {
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const currentTags = await storage.getPostTags(id);
        for (const tag of currentTags) {
          await storage.removeTagFromPost(id, tag.id);
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if (Array.isArray(tags) && tags.length > 0) {
          for (const tagId of tags) {
            try {
              await storage.addTagToPost(id, parseInt(tagId));
            } catch (tagError) {
              console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ ${tagId} Ù„Ù„Ù…Ù‚Ø§Ù„ ${id}:`, tagError);
            }
          }
        }
      }
      
      // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù‚Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø« Ù…Ø¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
      const updatedPost = await storage.getPost(id);
      const postTags = await storage.getPostTags(id);
      
      res.json({ ...updatedPost, tags: postTags });
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ù„:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.delete("/api/posts/:id", isAdmin, async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid post ID" });
    }
    const success = await storage.deletePost(id);
    if (!success) {
      return res.status(404).json({ message: "Post not found" });
    }
    res.json({ message: "Post deleted successfully" });
  });
  } // Ù†Ù‡Ø§ÙŠØ© Ø¨Ù„ÙˆÙƒ ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª (Posts)

  // Tag routes
  app.post("/api/tags", isAdmin, async (req, res) => {
    try {
      const data = insertTagSchema.parse(req.body);
      const tag = await storage.createTag(data);
      res.status(201).json(tag);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/tags", async (req, res) => {
    const tags = await storage.listTags();
    res.json(tags);
  });

  // Post-Tag relationship routes
  app.post("/api/posts/:postId/tags/:tagId", isAdmin, async (req, res) => {
    const postId = parseInt(req.params.postId);
    const tagId = parseInt(req.params.tagId);
    
    if (isNaN(postId) || isNaN(tagId)) {
      return res.status(400).json({ message: "Invalid post ID or tag ID" });
    }
    
    const post = await storage.getPost(postId);
    if (!post) {
      return res.status(404).json({ message: "Post not found" });
    }
    
    const tag = await storage.getTag(tagId);
    if (!tag) {
      return res.status(404).json({ message: "Tag not found" });
    }
    
    const postTag = await storage.addTagToPost(postId, tagId);
    res.status(201).json(postTag);
  });

  app.get("/api/posts/:postId/tags", async (req, res) => {
    const postId = parseInt(req.params.postId);
    if (isNaN(postId)) {
      return res.status(400).json({ message: "Invalid post ID" });
    }
    
    const post = await storage.getPost(postId);
    if (!post) {
      return res.status(404).json({ message: "Post not found" });
    }
    
    const tags = await storage.getPostTags(postId);
    res.json(tags);
  });

  app.delete("/api/posts/:postId/tags/:tagId", isAdmin, async (req, res) => {
    const postId = parseInt(req.params.postId);
    const tagId = parseInt(req.params.tagId);
    
    if (isNaN(postId) || isNaN(tagId)) {
      return res.status(400).json({ message: "Invalid post ID or tag ID" });
    }
    
    const success = await storage.removeTagFromPost(postId, tagId);
    if (!success) {
      return res.status(404).json({ message: "Post-tag relationship not found" });
    }
    
    res.json({ message: "Tag removed from post successfully" });
  });

  // === ÙˆØ­Ø¯Ø© Ù‚ØµØµ Ø§Ù„Ù†Ø¬Ø§Ø­ (Success Stories) ===
  if (!migratedModules.includes('success-stories')) {
    console.log('âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø§Ø±Ø§Øª Ù‚ØµØµ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (success-stories)');
    // Success Story routes
    app.post("/api/success-stories", isAdmin, async (req, res) => {
    try {
      const data = insertSuccessStorySchema.parse(req.body);
      const story = await storage.createSuccessStory(data);
      res.status(201).json(story);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/success-stories", async (req, res) => {
    const stories = await storage.listSuccessStories();
    res.json(stories);
  });

  app.get("/api/success-stories/:id", async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid success story ID" });
    }
    const story = await storage.getSuccessStory(id);
    if (!story) {
      return res.status(404).json({ message: "Success story not found" });
    }
    res.json(story);
  });

  app.get("/api/success-stories/slug/:slug", async (req, res) => {
    const slug = req.params.slug;
    const story = await storage.getSuccessStoryBySlug(slug);
    if (!story) {
      return res.status(404).json({ message: "Success story not found" });
    }
    res.json(story);
  });

  app.put("/api/success-stories/:id", isAdmin, async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid success story ID" });
    }
    try {
      const data = insertSuccessStorySchema.partial().parse(req.body);
      const story = await storage.updateSuccessStory(id, data);
      if (!story) {
        return res.status(404).json({ message: "Success story not found" });
      }
      res.json(story);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.delete("/api/success-stories/:id", isAdmin, async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid success story ID" });
    }
    const success = await storage.deleteSuccessStory(id);
    if (!success) {
      return res.status(404).json({ message: "Success story not found" });
    }
    res.json({ message: "Success story deleted successfully" });
  });
  } // Ù†Ù‡Ø§ÙŠØ© Ø¨Ù„ÙˆÙƒ ÙˆØ­Ø¯Ø© Ù‚ØµØµ Ø§Ù„Ù†Ø¬Ø§Ø­ (Success Stories)

  // Newsletter subscriber routes
  app.post("/api/subscribers", async (req, res) => {
    try {
      const data = insertSubscriberSchema.parse(req.body);
      
      // Check if subscriber already exists
      const existingSubscriber = await storage.getSubscriberByEmail(data.email);
      if (existingSubscriber) {
        return res.status(409).json({ message: "Email already subscribed" });
      }
      
      const subscriber = await storage.createSubscriber(data);
      res.status(201).json(subscriber);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/subscribers", isAdmin, async (req, res) => {
    const subscribers = await storage.listSubscribers();
    res.json(subscribers);
  });

  // SEO settings routes
  app.post("/api/seo-settings", isAdmin, async (req, res) => {
    try {
      const data = insertSeoSettingsSchema.parse(req.body);
      
      // Check if setting for this path already exists
      const existingSetting = await storage.getSeoSettingByPath(data.pagePath);
      if (existingSetting) {
        // Update instead of create
        const updated = await storage.updateSeoSetting(existingSetting.id, data);
        return res.json(updated);
      }
      
      const seoSetting = await storage.createSeoSetting(data);
      res.status(201).json(seoSetting);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/seo-settings", isAdmin, async (req, res) => {
    const settings = await storage.listSeoSettings();
    res.json(settings);
  });

  app.get("/api/seo-settings/path", async (req, res) => {
    const path = req.query.path as string;
    if (!path) {
      return res.status(400).json({ message: "Path parameter is required" });
    }
    
    const setting = await storage.getSeoSettingByPath(path);
    if (!setting) {
      return res.json({ 
        pagePath: path,
        metaTitle: "FULLSCO - Scholarship Blog",
        metaDescription: "Find and apply for scholarships worldwide with FULLSCO."
      });
    }
    
    res.json(setting);
  });

  app.put("/api/seo-settings/:id", isAdmin, async (req, res) => {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({ message: "Invalid SEO setting ID" });
    }
    try {
      const data = insertSeoSettingsSchema.partial().parse(req.body);
      const setting = await storage.updateSeoSetting(id, data);
      if (!setting) {
        return res.status(404).json({ message: "SEO setting not found" });
      }
      res.json(setting);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  // Site Settings routes
  app.get("/api/site-settings", async (req, res) => {
    const settings = await storage.getSiteSettings();
    if (!settings) {
      return res.status(404).json({ message: "Site settings not found" });
    }
    res.json(settings);
  });

  // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
  app.put("/api/site-settings", isAdmin, async (req, res) => {
    try {
      console.log("Received site settings update request:", JSON.stringify(req.body, null, 2));
      
      // Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      let data;
      try {
        data = insertSiteSettingsSchema.partial().parse(req.body);
        console.log("Parsed site settings data:", JSON.stringify(data, null, 2));
      } catch (parseError) {
        console.error("Site settings validation error:", parseError);
        return res.status(400).json({ 
          message: "Invalid data format", 
          details: (parseError as Error).message 
        });
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      const settings = await storage.updateSiteSettings(data);
      console.log("Site settings updated successfully:", JSON.stringify(settings, null, 2));
      
      // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
      res.json(settings);
    } catch (error) {
      console.error("Error updating site settings:", error);
      res.status(500).json({ 
        message: "Failed to update settings", 
        details: (error as Error).message 
      });
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø· (Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ø§Ù…)
  app.patch("/api/site-settings/general", isAdmin, async (req, res) => {
    try {
      console.log("Updating general site settings:", JSON.stringify(req.body, null, 2));
      
      const data = insertSiteSettingsSchema.partial().parse({
        siteName: req.body.siteName,
        siteTagline: req.body.siteTagline,
        siteDescription: req.body.siteDescription,
        rtlDirection: req.body.rtlDirection === true,
        enableDarkMode: req.body.enableDarkMode === true,
        defaultLanguage: req.body.defaultLanguage
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      const settings = await storage.updateSiteSettings(data);
      console.log("General settings updated successfully");
      
      // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
      res.json(settings);
    } catch (error) {
      console.error("Error updating general settings:", error);
      res.status(500).json({ message: "Failed to update general settings", error: (error as Error).message });
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙ‚Ø·
  app.patch("/api/site-settings/appearance", isAdmin, async (req, res) => {
    try {
      console.log("Updating appearance settings:", JSON.stringify(req.body, null, 2));
      
      const data = insertSiteSettingsSchema.partial().parse({
        primaryColor: req.body.primaryColor,
        secondaryColor: req.body.secondaryColor,
        accentColor: req.body.accentColor,
        favicon: req.body.favicon,
        logo: req.body.logo,
        logoDark: req.body.logoDark,
        customCss: req.body.customCss
      });
      
      const settings = await storage.updateSiteSettings(data);
      console.log("Appearance settings updated successfully");
      
      res.json(settings);
    } catch (error) {
      console.error("Error updating appearance settings:", error);
      res.status(500).json({ message: "Failed to update appearance settings", error: (error as Error).message });
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙ‚Ø·
  app.patch("/api/site-settings/contact", isAdmin, async (req, res) => {
    try {
      console.log("Updating contact settings:", JSON.stringify(req.body, null, 2));
      
      const data = insertSiteSettingsSchema.partial().parse({
        email: req.body.email,
        phone: req.body.phone,
        whatsapp: req.body.whatsapp,
        address: req.body.address,
        footerText: req.body.footerText
      });
      
      const settings = await storage.updateSiteSettings(data);
      console.log("Contact settings updated successfully");
      
      res.json(settings);
    } catch (error) {
      console.error("Error updating contact settings:", error);
      res.status(500).json({ message: "Failed to update contact settings", error: (error as Error).message });
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ ÙÙ‚Ø·
  app.patch("/api/site-settings/social", isAdmin, async (req, res) => {
    try {
      console.log("Updating social media settings:", JSON.stringify(req.body, null, 2));
      
      const data = insertSiteSettingsSchema.partial().parse({
        facebook: req.body.facebook,
        twitter: req.body.twitter,
        instagram: req.body.instagram,
        youtube: req.body.youtube,
        linkedin: req.body.linkedin
      });
      
      const settings = await storage.updateSiteSettings(data);
      console.log("Social media settings updated successfully");
      
      res.json(settings);
    } catch (error) {
      console.error("Error updating social media settings:", error);
      res.status(500).json({ message: "Failed to update social media settings", error: (error as Error).message });
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø· (Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…)
  app.patch("/api/site-settings/homepage", isAdmin, async (req, res) => {
    try {
      console.log("Updating homepage settings:", JSON.stringify(req.body, null, 2));
      
      // Ù†Ø¹ÙŠÙ† Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¨ÙˆÙ„ÙŠØ§Ù†ÙŠØ©
      const booleanData = {
        showHeroSection: true,
        showFeaturedScholarships: true, // Ø¯Ø§Ø¦Ù…Ø§ true Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
        showSearchSection: true,
        showCategoriesSection: true,
        showCountriesSection: true,
        showLatestArticles: true,
        showSuccessStories: true,
        showNewsletterSection: true,
        showStatisticsSection: true,
        showPartnersSection: true,
        enableNewsletter: true,
        enableScholarshipSearch: true
      };
      
      // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† req.body Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØµØ§Ù„Ø­Ø©
      // Ù„ÙƒÙ† Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
      
      // Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ØµØ­ÙŠØ­
      const data = insertSiteSettingsSchema.partial().parse(booleanData);
      
      console.log("Processing homepage settings with fixed boolean values:", JSON.stringify(data, null, 2));
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const settings = await storage.updateSiteSettings(data);
      console.log("Homepage settings updated successfully:", settings);
      
      // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
      res.json(settings);
    } catch (error) {
      console.error("Error updating homepage settings:", error);
      res.status(500).json({ message: "Failed to update homepage settings", error: (error as Error).message });
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙ‚Ø·
  app.patch("/api/site-settings/sections", isAdmin, async (req, res) => {
    try {
      console.log("Updating section titles and descriptions:", JSON.stringify(req.body, null, 2));
      
      const data = insertSiteSettingsSchema.partial().parse({
        heroTitle: req.body.heroTitle,
        heroDescription: req.body.heroDescription,
        featuredScholarshipsTitle: req.body.featuredScholarshipsTitle,
        featuredScholarshipsDescription: req.body.featuredScholarshipsDescription,
        categoriesSectionTitle: req.body.categoriesSectionTitle,
        categoriesSectionDescription: req.body.categoriesSectionDescription,
        countriesSectionTitle: req.body.countriesSectionTitle,
        countriesSectionDescription: req.body.countriesSectionDescription,
        latestArticlesTitle: req.body.latestArticlesTitle,
        latestArticlesDescription: req.body.latestArticlesDescription,
        successStoriesTitle: req.body.successStoriesTitle,
        successStoriesDescription: req.body.successStoriesDescription,
        newsletterSectionTitle: req.body.newsletterSectionTitle,
        newsletterSectionDescription: req.body.newsletterSectionDescription,
        statisticsSectionTitle: req.body.statisticsSectionTitle,
        statisticsSectionDescription: req.body.statisticsSectionDescription,
        partnersSectionTitle: req.body.partnersSectionTitle,
        partnersSectionDescription: req.body.partnersSectionDescription
      });
      
      const settings = await storage.updateSiteSettings(data);
      console.log("Section titles updated successfully");
      
      res.json(settings);
    } catch (error) {
      console.error("Error updating section titles:", error);
      res.status(500).json({ message: "Failed to update section titles", error: (error as Error).message });
    }
  });

  // Analytics routes
  app.get("/api/analytics/visits", isAdmin, async (req, res) => {
    try {
      const period = req.query.period as string || 'monthly';
      const data = await storage.getVisitStats(period);
      res.json(data);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  app.get("/api/analytics/posts", isAdmin, async (req, res) => {
    try {
      const stats = await storage.getPostStats();
      res.json(stats);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  app.get("/api/analytics/scholarships", isAdmin, async (req, res) => {
    try {
      const stats = await storage.getScholarshipStats();
      res.json(stats);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  app.get("/api/analytics/traffic-sources", isAdmin, async (req, res) => {
    try {
      const sources = await storage.getTrafficSources();
      res.json(sources);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  app.get("/api/analytics/top-content", isAdmin, async (req, res) => {
    try {
      const type = req.query.type as string || 'posts';
      const limit = parseInt(req.query.limit as string || '5');
      const content = await storage.getTopContent(type, limit);
      res.json(content);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  app.get("/api/analytics/dashboard", isAdmin, async (req, res) => {
    try {
      // Ø¬Ù…Ø¹ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
      const period = req.query.period as string || 'monthly';
      
      const [visitStats, postStats, scholarshipStats, trafficSources, topPosts, topScholarships] = await Promise.all([
        storage.getVisitStats(period),
        storage.getPostStats(),
        storage.getScholarshipStats(),
        storage.getTrafficSources(),
        storage.getTopContent('posts', 5),
        storage.getTopContent('scholarships', 5)
      ]);
      
      res.json({
        visitStats,
        postStats,
        scholarshipStats,
        trafficSources,
        topContent: {
          posts: topPosts,
          scholarships: topScholarships
        }
      });
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  // Static Pages Routes
  // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© Ø«Ø§Ø¨ØªØ© Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
  app.post("/api/pages", isAdmin, async (req, res) => {
    try {
      const data = insertPageSchema.parse(req.body);
      const page = await storage.createPage(data);
      res.status(201).json(page);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
  app.get("/api/admin/pages", isAdmin, async (req, res) => {
    try {
      const pages = await storage.listPages();
      res.json(pages);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
  app.get("/api/pages", async (req, res) => {
    try {
      // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒØ§Ù†: Ø§Ù„Ø±Ø£Ø³ Ø£Ùˆ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø£Ùˆ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©
      const showInHeader = req.query.header === "true";
      const showInFooter = req.query.footer === "true";
      
      const filters: {
        isPublished: boolean;
        showInHeader?: boolean;
        showInFooter?: boolean;
      } = {
        isPublished: true
      };
      
      if (req.query.header !== undefined) {
        filters.showInHeader = showInHeader;
      }
      
      if (req.query.footer !== undefined) {
        filters.showInFooter = showInFooter;
      }
      
      const pages = await storage.listPages(filters);
      res.json(pages);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø«Ø§Ø¨ØªØ© Ù…Ø­Ø¯Ø¯Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø¹Ø±Ù (Ù…Ø¯ÙŠØ± ÙÙ‚Ø· Ù„Ù„ØµÙØ­Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©)
  app.get("/api/pages/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Ù…Ø¹Ø±Ù Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± ØµØ§Ù„Ø­" });
      }
      
      const page = await storage.getPage(id);
      if (!page) {
        return res.status(404).json({ message: "Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©" });
      }
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±Ù‹Ø§
      if (!page.isPublished && (!req.isAuthenticated() || (req.user as User).role !== "admin")) {
        return res.status(403).json({ message: "ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„" });
      }
      
      res.json(page);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø«Ø§Ø¨ØªØ© Ù…Ø­Ø¯Ø¯Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±
  app.get("/api/pages/slug/:slug", async (req, res) => {
    try {
      const slug = req.params.slug;
      const page = await storage.getPageBySlug(slug);
      
      if (!page) {
        return res.status(404).json({ message: "Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©" });
      }
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±Ù‹Ø§
      if (!page.isPublished && (!req.isAuthenticated() || (req.user as User).role !== "admin")) {
        return res.status(403).json({ message: "ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„" });
      }
      
      res.json(page);
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø«Ø§Ø¨ØªØ© (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
  app.put("/api/pages/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Ù…Ø¹Ø±Ù Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± ØµØ§Ù„Ø­" });
      }
      
      const data = insertPageSchema.partial().parse(req.body);
      const page = await storage.updatePage(id, data);
      
      if (!page) {
        return res.status(404).json({ message: "Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©" });
      }
      
      res.json(page);
    } catch (error) {
      res.status(400).json({ message: (error as Error).message });
    }
  });

  // Ø­Ø°Ù ØµÙØ­Ø© Ø«Ø§Ø¨ØªØ© (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
  app.delete("/api/pages/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Ù…Ø¹Ø±Ù Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± ØµØ§Ù„Ø­" });
      }
      
      const success = await storage.deletePage(id);
      if (!success) {
        return res.status(404).json({ message: "Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©" });
      }
      
      res.status(204).end();
    } catch (error) {
      res.status(500).json({ message: (error as Error).message });
    }
  });

  // Menu Routes
  app.post("/api/menus", isAdmin, async (req, res) => {
    try {
      const data = insertMenuSchema.parse(req.body);
      const menu = await storage.createMenu(data);
      res.status(201).json(menu);
    } catch (error) {
      console.error("Error creating menu:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/menus", async (req, res) => {
    try {
      const menus = await storage.listMenus();
      res.json(menus);
    } catch (error) {
      console.error("Error fetching menus:", error);
      res.status(500).json({ message: "Failed to fetch menus", error: (error as Error).message });
    }
  });

  app.get("/api/menus/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid menu ID" });
      }
      const menu = await storage.getMenu(id);
      if (!menu) {
        return res.status(404).json({ message: "Menu not found" });
      }
      res.json(menu);
    } catch (error) {
      console.error("Error fetching menu:", error);
      res.status(500).json({ message: "Failed to fetch menu", error: (error as Error).message });
    }
  });

  app.get("/api/menus/location/:location", async (req, res) => {
    try {
      const location = req.params.location;
      if (!["header", "footer", "sidebar", "mobile"].includes(location)) {
        return res.status(400).json({ message: "Invalid menu location" });
      }
      const menu = await storage.getMenuByLocation(location);
      if (!menu) {
        return res.status(404).json({ message: "Menu not found for this location" });
      }
      res.json(menu);
    } catch (error) {
      console.error("Error fetching menu by location:", error);
      res.status(500).json({ message: "Failed to fetch menu", error: (error as Error).message });
    }
  });

  app.get("/api/menus/slug/:slug", async (req, res) => {
    try {
      const slug = req.params.slug;
      const menu = await storage.getMenuBySlug(slug);
      if (!menu) {
        return res.status(404).json({ message: "Menu not found" });
      }
      res.json(menu);
    } catch (error) {
      console.error("Error fetching menu by slug:", error);
      res.status(500).json({ message: "Failed to fetch menu", error: (error as Error).message });
    }
  });

  // GET Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù‡ÙŠÙƒÙ„ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  app.get("/api/menu-structure", async (req, res) => {
    try {
      const locations = ["header", "footer", "sidebar", "mobile"];
      const structures = {};
      
      for (const loc of locations) {
        try {
          const structure = await storage.getMenuStructure(loc);
          if (structure) {
            structures[loc] = structure;
          }
        } catch (innerError) {
          console.error(`Error fetching menu structure for ${loc}:`, innerError);
          // Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰
        }
      }
      
      res.json(structures);
    } catch (error) {
      console.error("Error fetching all menu structures:", error);
      res.status(500).json({ message: "Failed to fetch menu structures", error: (error as Error).message });
    }
  });

  // GET Ù…Ø­Ø¯Ø¯ Ù„Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  app.get("/api/menu-structure/:location", async (req, res) => {
    try {
      const location = req.params.location;
      if (!["header", "footer", "sidebar", "mobile"].includes(location)) {
        return res.status(400).json({ message: "Invalid menu location" });
      }
      const structure = await storage.getMenuStructure(location);
      if (!structure) {
        return res.status(404).json({ message: "Menu structure not found for this location" });
      }
      res.json(structure);
    } catch (error) {
      console.error("Error fetching menu structure:", error);
      res.status(500).json({ message: "Failed to fetch menu structure", error: (error as Error).message });
    }
  });

  app.put("/api/menus/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid menu ID" });
      }
      const data = insertMenuSchema.partial().parse(req.body);
      const menu = await storage.updateMenu(id, data);
      if (!menu) {
        return res.status(404).json({ message: "Menu not found" });
      }
      res.json(menu);
    } catch (error) {
      console.error("Error updating menu:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.delete("/api/menus/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid menu ID" });
      }
      const success = await storage.deleteMenu(id);
      if (!success) {
        return res.status(404).json({ message: "Menu not found" });
      }
      res.json({ message: "Menu deleted successfully" });
    } catch (error) {
      console.error("Error deleting menu:", error);
      res.status(500).json({ message: "Failed to delete menu", error: (error as Error).message });
    }
  });

  // Menu Item Routes
  app.post("/api/menu-items", isAdmin, async (req, res) => {
    try {
      const data = insertMenuItemSchema.parse(req.body);
      const menuItem = await storage.createMenuItem(data);
      res.status(201).json(menuItem);
    } catch (error) {
      console.error("Error creating menu item:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.get("/api/menu-items/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid menu item ID" });
      }
      const menuItem = await storage.getMenuItem(id);
      if (!menuItem) {
        return res.status(404).json({ message: "Menu item not found" });
      }
      res.json(menuItem);
    } catch (error) {
      console.error("Error fetching menu item:", error);
      res.status(500).json({ message: "Failed to fetch menu item", error: (error as Error).message });
    }
  });

  app.get("/api/menu-items/menu/:menuId", async (req, res) => {
    try {
      const menuId = parseInt(req.params.menuId);
      if (isNaN(menuId)) {
        return res.status(400).json({ message: "Invalid menu ID" });
      }
      
      let parentId: number | null | undefined = undefined;
      if (req.query.parentId !== undefined) {
        if (req.query.parentId === 'null') {
          parentId = null;
        } else {
          const parsedParentId = parseInt(req.query.parentId as string);
          if (!isNaN(parsedParentId)) {
            parentId = parsedParentId;
          } else {
            return res.status(400).json({ message: "Invalid parent ID" });
          }
        }
      }
      
      const menuItems = await storage.listMenuItems(menuId, parentId);
      res.json(menuItems);
    } catch (error) {
      console.error("Error fetching menu items:", error);
      res.status(500).json({ message: "Failed to fetch menu items", error: (error as Error).message });
    }
  });

  app.get("/api/menu-items-with-details/menu/:menuId", async (req, res) => {
    try {
      const menuId = parseInt(req.params.menuId);
      if (isNaN(menuId)) {
        return res.status(400).json({ message: "Invalid menu ID" });
      }
      const menuItems = await storage.getAllMenuItemsWithDetails(menuId);
      res.json(menuItems);
    } catch (error) {
      console.error("Error fetching menu items with details:", error);
      res.status(500).json({ message: "Failed to fetch menu items with details", error: (error as Error).message });
    }
  });

  app.put("/api/menu-items/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid menu item ID" });
      }
      const data = insertMenuItemSchema.partial().parse(req.body);
      const menuItem = await storage.updateMenuItem(id, data);
      if (!menuItem) {
        return res.status(404).json({ message: "Menu item not found" });
      }
      res.json(menuItem);
    } catch (error) {
      console.error("Error updating menu item:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.delete("/api/menu-items/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid menu item ID" });
      }
      const success = await storage.deleteMenuItem(id);
      if (!success) {
        return res.status(404).json({ message: "Menu item not found" });
      }
      res.json({ message: "Menu item deleted successfully" });
    } catch (error) {
      console.error("Error deleting menu item:", error);
      res.status(500).json({ message: "Failed to delete menu item", error: (error as Error).message });
    }
  });

  // Media routes
  // Get a list of all media files
  app.get("/api/media", async (req, res) => {
    try {
      const mimeType = req.query.mimeType as string | undefined;
      const filters = mimeType ? { mimeType } : undefined;
      const mediaFiles = await storage.listMediaFiles(filters);
      res.json(mediaFiles);
    } catch (error) {
      console.error("Error fetching media files:", error);
      res.status(500).json({ message: "Failed to fetch media files", error: (error as Error).message });
    }
  });

  // Get a single media file by ID
  app.get("/api/media/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid media file ID" });
      }
      const mediaFile = await storage.getMediaFile(id);
      if (!mediaFile) {
        return res.status(404).json({ message: "Media file not found" });
      }
      res.json(mediaFile);
    } catch (error) {
      console.error("Error fetching media file:", error);
      res.status(500).json({ message: "Failed to fetch media file", error: (error as Error).message });
    }
  });

  // Upload a new media file
  app.post("/api/media", isAdmin, upload.single('file'), async (req, res) => {
    try {
      if (!req.file) {
        return res.status(400).json({ message: 'No file uploaded' });
      }

      // Process the uploaded file
      const file = req.file;
      
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ù„Ù Ù‡Ùˆ ØµÙˆØ±Ø©
      let width = null;
      let height = null;
      
      if (file.mimetype.startsWith('image/')) {
        try {
          const filePath = path.join(uploadsDir, file.filename);
          const dimensions = sizeOf(filePath);
          width = dimensions.width;
          height = dimensions.height;
          console.log(`Image dimensions: ${width}x${height}`);
        } catch (err) {
          console.error("Error getting image dimensions:", err);
          // Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
        }
      }
      
      // Use relative URL instead of absolute URL to avoid server-specific paths
      const fileData = {
        filename: file.filename,
        originalFilename: file.originalname,
        url: `/uploads/${file.filename}`,
        mimeType: file.mimetype,
        size: file.size,
        width,
        height,
        title: req.body.title || file.originalname,
        alt: req.body.alt || ''
      };

      console.log("Uploading file with data:", fileData);
      
      // Save media file to database
      const mediaFile = await storage.createMediaFile(fileData);
      
      // Return success response
      res.status(201).json(mediaFile);
    } catch (error) {
      console.error("Error creating media file:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  // Update an existing media file
  app.put("/api/media/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid media file ID" });
      }
      const data = insertMediaFileSchema.partial().parse(req.body);
      const mediaFile = await storage.updateMediaFile(id, data);
      if (!mediaFile) {
        return res.status(404).json({ message: "Media file not found" });
      }
      res.json(mediaFile);
    } catch (error) {
      console.error("Error updating media file:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  // Delete a media file
  app.delete("/api/media/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid media file ID" });
      }
      const success = await storage.deleteMediaFile(id);
      if (!success) {
        return res.status(404).json({ message: "Media file not found" });
      }
      res.json({ message: "Media file deleted successfully" });
    } catch (error) {
      console.error("Error deleting media file:", error);
      res.status(500).json({ message: "Failed to delete media file", error: (error as Error).message });
    }
  });

  // Bulk delete media files
  app.post("/api/media/bulk-delete", isAdmin, async (req, res) => {
    try {
      const { ids } = req.body;
      if (!Array.isArray(ids) || ids.some(id => typeof id !== 'number')) {
        return res.status(400).json({ message: "Invalid IDs format. Expected an array of numbers." });
      }
      
      const success = await storage.bulkDeleteMediaFiles(ids);
      if (!success) {
        return res.status(500).json({ message: "Failed to delete some media files" });
      }
      
      res.json({ message: "Media files deleted successfully" });
    } catch (error) {
      console.error("Error bulk deleting media files:", error);
      res.status(500).json({ message: "Failed to delete media files", error: (error as Error).message });
    }
  });

  // Statistics routes
  app.get("/api/statistics", async (req, res) => {
    try {
      const { active } = req.query;
      const filters: any = {};
      
      if (active !== undefined) {
        filters.isActive = active === "true";
      }
      
      const statistics = await storage.listStatistics(Object.keys(filters).length > 0 ? filters : undefined);
      res.json(statistics);
    } catch (error) {
      console.error("Error fetching statistics:", error);
      res.status(500).json({ message: "Failed to fetch statistics", error: (error as Error).message });
    }
  });

  app.get("/api/statistics/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid statistic ID" });
      }
      const statistic = await storage.getStatistic(id);
      if (!statistic) {
        return res.status(404).json({ message: "Statistic not found" });
      }
      res.json(statistic);
    } catch (error) {
      console.error("Error fetching statistic:", error);
      res.status(500).json({ message: "Failed to fetch statistic", error: (error as Error).message });
    }
  });

  app.post("/api/statistics", isAdmin, async (req, res) => {
    try {
      const data = insertStatisticSchema.parse(req.body);
      const statistic = await storage.createStatistic(data);
      res.status(201).json(statistic);
    } catch (error) {
      console.error("Error creating statistic:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  // Ù†Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù‹Ø§ Ù…Ù† PUT Ùˆ PATCH Ù„Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
  app.put("/api/statistics/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid statistic ID" });
      }
      const data = insertStatisticSchema.partial().parse(req.body);
      const statistic = await storage.updateStatistic(id, data);
      if (!statistic) {
        return res.status(404).json({ message: "Statistic not found" });
      }
      res.json(statistic);
    } catch (error) {
      console.error("Error updating statistic:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });
  
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ PATCH Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
  app.patch("/api/statistics/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid statistic ID" });
      }
      const data = insertStatisticSchema.partial().parse(req.body);
      const statistic = await storage.updateStatistic(id, data);
      if (!statistic) {
        return res.status(404).json({ message: "Statistic not found" });
      }
      res.json(statistic);
    } catch (error) {
      console.error("Error updating statistic (PATCH):", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.delete("/api/statistics/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid statistic ID" });
      }
      const success = await storage.deleteStatistic(id);
      if (!success) {
        return res.status(404).json({ message: "Statistic not found" });
      }
      res.json({ message: "Statistic deleted successfully" });
    } catch (error) {
      console.error("Error deleting statistic:", error);
      res.status(500).json({ message: "Failed to delete statistic", error: (error as Error).message });
    }
  });

  // Partners routes
  app.get("/api/partners", async (req, res) => {
    try {
      const { active } = req.query;
      const filters: any = {};
      
      if (active !== undefined) {
        filters.isActive = active === "true";
      }
      
      const partners = await storage.listPartners(Object.keys(filters).length > 0 ? filters : undefined);
      res.json(partners);
    } catch (error) {
      console.error("Error fetching partners:", error);
      res.status(500).json({ message: "Failed to fetch partners", error: (error as Error).message });
    }
  });

  app.get("/api/partners/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid partner ID" });
      }
      const partner = await storage.getPartner(id);
      if (!partner) {
        return res.status(404).json({ message: "Partner not found" });
      }
      res.json(partner);
    } catch (error) {
      console.error("Error fetching partner:", error);
      res.status(500).json({ message: "Failed to fetch partner", error: (error as Error).message });
    }
  });

  app.post("/api/partners", isAdmin, async (req, res) => {
    try {
      const data = insertPartnerSchema.parse(req.body);
      const partner = await storage.createPartner(data);
      res.status(201).json(partner);
    } catch (error) {
      console.error("Error creating partner:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  // Ù†Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù‹Ø§ Ù…Ù† PUT Ùˆ PATCH Ù„Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
  app.put("/api/partners/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid partner ID" });
      }
      const data = insertPartnerSchema.partial().parse(req.body);
      const partner = await storage.updatePartner(id, data);
      if (!partner) {
        return res.status(404).json({ message: "Partner not found" });
      }
      res.json(partner);
    } catch (error) {
      console.error("Error updating partner:", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });
  
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ PATCH Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
  app.patch("/api/partners/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid partner ID" });
      }
      const data = insertPartnerSchema.partial().parse(req.body);
      const partner = await storage.updatePartner(id, data);
      if (!partner) {
        return res.status(404).json({ message: "Partner not found" });
      }
      res.json(partner);
    } catch (error) {
      console.error("Error updating partner (PATCH):", error);
      res.status(400).json({ message: (error as Error).message });
    }
  });

  app.delete("/api/partners/:id", isAdmin, async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      if (isNaN(id)) {
        return res.status(400).json({ message: "Invalid partner ID" });
      }
      const success = await storage.deletePartner(id);
      if (!success) {
        return res.status(404).json({ message: "Partner not found" });
      }
      res.json({ message: "Partner deleted successfully" });
    } catch (error) {
      console.error("Error deleting partner:", error);
      res.status(500).json({ message: "Failed to delete partner", error: (error as Error).message });
    }
  });
  } // Ù†Ù‡Ø§ÙŠØ© Ø¨Ù„ÙˆÙƒ ÙˆØ­Ø¯Ø© Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ (Partners)

  const httpServer = createServer(app);
  return httpServer;
}
